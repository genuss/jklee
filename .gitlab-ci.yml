variables:
  BUILDER_IMAGE: $DOCKER_REGISTRY_DEV/devops/processing-java-builder:j18.0.2-10-i1
  DOCKER_REGISTRY_DEV: 560755210414.dkr.ecr.eu-central-1.amazonaws.com
  GRADLE_USER_HOME: .gradle-home

  ARTIFACT_COMPRESSION_LEVEL: fastest
  CACHE_COMPRESSION_LEVEL: slowest
  FF_USE_FASTZIP: 'true'
  TRANSFER_METER_FREQUENCY: 2s

stages:
  - cache-build
  - source-build

populate-gradle-cache:
  cache:
    - key: gradle
      policy: pull-push
      paths:
        - $GRADLE_USER_HOME/caches/jars-9
        - $GRADLE_USER_HOME/caches/modules-2
        - $GRADLE_USER_HOME/caches/transforms-3
        - $GRADLE_USER_HOME/notifications
        - $GRADLE_USER_HOME/wrapper
        - spring-boot-admin/node
        - spring-boot-admin/node_modules
  image: $BUILDER_IMAGE
  only:
    refs:
      - master
      - vivid
#    variables:
#      - $GRADLE_POPULATE_CACHE == "true"
    changes:
      - build.gradle
      - gradle/wrapper/gradle-wrapper.properties
      - settings.gradle
      - spring-boot-admin/package-lock.json
      - spring-boot-admin/package.json
      - .gitlab-ci.yml # remove later
  script:
    - env | sort
    - ./gradlew :spring-boot-admin:installNode --parallel
    - ls -lh spring-boot-admin
    - ls -lh spring-boot-admin/node
    - ls -lh spring-boot-admin/node/bin
    - ./spring-boot-admin/node/bin/npm set registry https://nexus.px019.net/repository/nodejs-org-dist/
    - ./gradlew :spring-boot-admin:installFrontend --parallel
    - ./gradlew clean dependencies --parallel
  stage: cache-build
  tags: [ build ]

#gradle-build:
#  artifacts:
#    when: always
#    paths:
#      - build/reports
#      - '*/build/reports'
#  cache:
#    - key: gradle
#      policy: pull
#      paths:
#        - $GRADLE_USER_HOME
#    - key: build-$CI_COMMIT_REF_NAME
#      policy: pull-push
#      paths:
#        - build
#        - '*/build'
#  image: $BUILDER_IMAGE
#  script:
#    - env | sort
#    - npm set registry https://nexus.px019.net/repository/nodejs-org-dist/
#    - ./gradlew build publish --parallel
#  stage: source-build
#  tags: [ build ]
